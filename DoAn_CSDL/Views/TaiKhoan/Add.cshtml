@using QuanLyKho.Models
@{
    ViewBag.Title = "Thêm tài khoản";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}

<div class="main--content">
    <h1 class="main--title">THÊM TÀI KHOẢN:</h1>
    <form class="form-group form-themtk" onsubmit="return false;">
        <div class="row">
            <div class="col-12 col-md-8">
                <label for="file_avatar">Ảnh đại diện:</label>
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEwAACxMBAJqcGAAACYVJREFUeJzt3VmsXVUdx/HvvS2QlhZCobRSbAG1lVYaKzE4gEBjYtRojKhRA+KAiT44RI0xGqMPRBMxTkmjsRKNsyYYp4ACMijyZDSpUilWC7UtlKGl3NLS2YfVam1vV2/v2Wf/197r+0n+uS83Of+z9vqdPe89gto0H1gKLAQWHfw7G5gBzDxYB4DtwNjBehT4B7DmYK0CNrTduDQMZwNXAzcC60iTv4laC6wE3gac1dq3kRowDXgrcDOwl+ZCcazaA/wKeDNwSgvfT5qUecBXgG0MPxTHqq3ADcDcIX9XacIuAL4J7CIuGEfWTmAFsGCI31vKOhX4ArCb+EAcq3YB15M2+6TWXAWsJz4AE61/Aa8dykhIhzkN+DHxE36y9R3Smk9q3DLS+YjoST5orQaWNDw2qtw7gWeIn9xN1Q7SoWhpYJ8gfkIPo/YDH2xwnFSZEeDLxE/kYdfnmhow1WUF8ZO3rbqhoTFTJT5D/KRtuz7WyMip995H/GSNqP3ANQ2Mn3rsCtq5wLDU2g1cMuggqp/OBjYRP0mjax1wxoBjqZ4ZBW4lfnKWUj8fbDjVNx8iflKWVtcNNKLqjXOAp4ifkKXVE3i3IlOiGyjASuBF0U0UaBpwJvDL6EYU50rif6lLrv14VKtqdxM/CUuvmyc9uuq0S4mffF0pN0Er9BviJ15X6qZJjrE6ajHxk65LtR84f1Ij3XGj0Q0EuTa6gY4ZodLrtEaiGwgwSnrgwrzoRjpmLfC86CbaVuMaZDmGYzKeC7w0uom21RiQN0Q30GHVjV2NAVke3UCHVTd2te2DzAUejm6iw/aRrs96MrqRttS2BrkyuoGOmwJcHt1Em2oLyMXRDfRAVWfVawvIougGeqCqMTQgOlFVjWFNO+knkR65OTW6kY7bQXqn4oHoRtpQ0xpkDoajCdOp6KEONQVkZnQDPVLNWNYUkBnRDfSIAemhahZqC6oZy5oCcnJ0Az1SzVjWFJDt0Q30SDVjaUA0GWPRDbSlpoBUs1BbUM1Y1hSQrdEN9Mi26AbaUlNAtlDRZdpDtIl0Nr0KNQUEYE10Az1Q1RjWFpAHohvoAQPSY6ujG+iBv0c30KbaAnJPdAM98IfoBtpU0+XukC553wqcGt1IR20h3ZNexaXuUN8aZA/wx+gmOuwuKgoH1BcQgNuiG+iw6sautk0sgHOBh6jzx2EQe0ivq3s8upE21ThJNgB3RjfRQbdQWTigzoAAfDe6gQ76XnQDEWrcxIJ0FOvfVHRv9YA2AwuAXdGNtK3WNcjTwNeim+iQL1FhOKDeNQjALNLOuveq520hrT2qvJ+m1jUIpAX/9egmOuCrVBoOpbXIo8S/A7DU2oBr2Oq9i/iJWGq9ZYBxVU+MkC5ijJ6MpdWtgwyq+mUJ6S656ElZSo2R3kko/dd7iZ+YpdTbBxxL9dQPiZ+c0bVy4FFUb80E7iN+kkbVn4FpA4+ieu1cYD3xk7XtWkt6RYR0XBcCTxA/aduqR4DnNDJyqsYlpNtzoyfvsOsxYFlDY6bKXARsJH4SD6sepLJ3Dqp5C4D7iZ/MTdcq0h2C0sBmAb8mflI3VTcBpzc6QqreCPBx0r3Z0RN8srUL+EDTAyMd7mV0c5Prr8DFQxgP6SgnA5+kG9dvjQEfxVdgK8AC4CfAPuKDcGTtBb4PzBvat5cm6PmkJ6WUsH+yG7gRr8ZVgc4HPk96YkrbwXgQuB6YP+wvKQ1qFFgOfBt4mOGFYiPwLeBy6n4Ax9A4qO1YTArMFaSz8xdw4jvNe4B/ko5G3QncQWUvs4lgQGKcRArJQmA26TL7Q3XoyNOheowUhHWkHW9JkiRJkqT6eBQrb4R0z8RCYC7pMZyHH3E6kUO1B4bwvxP9v72k5+uOHfb3cdJ74zecYG9VMSD/Mwq8gHS+4sWky0cW0v9n0+4gBWUN6akmdwB/IV1fVr3aAzIbeCPwStJJvLNCuynHNuBu4HfAz0hrGVXiFOAq4BeUcXFh6bWf9Jzeq/H98r32LOCLpPeCRE+6rtZ24BukqwDUEwuAFcAzxE+wvtRe0uX9F57AclBhziT92rkZNbzaT3qesTdldcgo8B7SYczoCVRLjQEfIV2EqYItBe4lfsLUWqtID7VQYUaA9+N+Rgm1j/RAi5pfEFuU04GfEj8xrP+v35LOMynQRaTH9kdPBmv82gi85JhLT0N1GfAk8ZPAytcO4NXHWIYaktcDO4lf+NbEag/pTLxacC3pRFX0QrdOvD48zvJUg95EOjkVvaCtydd1Ry1VNWI56enk0QvYGqz2kTaR1aBlwFPEL1yrmdoJvJwO6ML9IHNJN/DMjW5EjdpK+uF7KLqRnNLPdk4BfoDh6KMzgB9R+PVbU6IbOI5PA++ObkJD82zSu1Zuj26ki66kzPduWM1XsScSS90HmQ6sJt3spP7bRHpIxlh0I0cqdRPrs8DroptQa2aS9kVui27kSCWuQRaRHvFf9M6bGrcXeCFwX3QjhyvtKNYI6f5xw1GfqaRlX+KPdjFeRfwOoxVbr6EgpaX196TL2FWve4FLSWEJV9Im1mUYDqV72l8R3cQhJQXkU9ENqBjFzIVSNrGWAH+LbkJFWUo6mhmqlDXIO6IbUHGuiW4AyliDTAHWk97DIR2yCZhP8GsYSliDLMdw6GjnkK7HC1VCQIpYlapI4Q96iN7EGgUewQeMaXybSa+tCDsnEr0GWYLh0LHNIV3lGyY6IOHbmCpe6ByJDsjy4M9X+ULnSOQ+yAjpHR6zAntQ+TYT+EyCyDXIbAyHjm8O6QEPISIDsijws9UtYXPFgKgLDIiUUWVAzgv8bHXLeVEfPDXqg4HTWvysp4H7j/M/i4AZLfTSBWPAA8f5n8XAtBZ6gfTUk+q0+TbaeybQz+0t9lN63TKB8fpTi/3cNYF+hiJyE8tfa01U2BokMiBVrjY1KVUGpK3tV3Xf9KgPjr4WSyqaAZEyDIiUYUCkDAMiZRgQKcOASBkGRMowIFKGAZEyDIiUYUCkDAMiZRgQKcOASBkGRMowIFKGAZEyDIiUYUCkDAMiZRgQKcOASBkGRMowIFKGAZEyDIiUYUCkDAMiZRgQjedAdAOlMCBShgGRMgyIxuMm1kEGRMowIFKGAZEyDIiUYUCkDAMiZRgQKcOASBkGRMowIFKGAZEyDIiUYUCkDAMiZRgQKcOASBkGRMowIFKGAZEyDIjG4z3pBxkQKcOASBkGRMowIFKGAZEyDIiUYUCkDAMiZRgQKeM/ie5jPscIOMQAAAAASUVORK5CYII=" class="my-3 detail--img" onclick="ShowImage(this)" id="avatar" />
                <input type="file" class="form-control-file" accept="image/*" onchange="ReplaceImage(this)"/>
            </div>
            <div class="col-12 col-md-8">
                <label for="txt_HoTen">Họ và tên<span class="required">(*)</span>:</label>
                <input type="text" name="txt_HoTen" class="form-control" autocomplete="off" maxlength="200" autofocus />
            </div>
            <div class="col-12 col-md-4">
                <label for="txt_NgaySinh">Ngày sinh<span class="required">(*)</span>:</label>
                <input type="date" name="txt_NgaySinh" class="form-control" autocomplete="off" />
            </div>
            <div class="col-12 col-md-12">
                <label for="txt_DiaChi">Địa chỉ:</label>
                <input type="text" name="txt_DiaChi" class="form-control" autocomplete="off" maxlength="300" />
            </div>
            <div class="col-12 col-md-6">
                <label for="txt_SDT">Số điện thoại<span class="required">(*)</span>:</label>
                <input type="text" name="txt_SDT" class="form-control" autocomplete="off" maxlength="11" placeholder="VD: 0964062210"/>
            </div>
            <div class="col-8">
                <label for="txt_TaiKhoan">Tên tài khoản<span class="required">(*)</span>:</label>
                <input type="text" name="txt_TaiKhoan" class="form-control" autocomplete="off" maxlength="100" />
            </div>
            <div class="col-12 col-md-8">
                <label for="txt_MatKhau">Mật khẩu<span class="required">(*)</span>:</label>
                <div class="d-flex">
                    <input type="password" name="txt_MatKhau" class="form-control" autocomplete="off" maxlength="100" />
                    <button type="button" class="showPas" onclick="ShowPas(this)" tabindex="-1">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div class="col-12 col-md-8">
                <label for="txt_ReMatKhau">Nhập lại mật khẩu<span class="required">(*)</span>:</label>
                <div class="d-flex">
                    <input type="password" name="txt_ReMatKhau" class="form-control" autocomplete="off" maxlength="100" />
                    <button type="button" class="showPas" onclick="ShowPas(this)" tabindex="-1">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <label for="sel_PhanQuyen">Phân quyền: </label>
                <select name="sel_PhanQuyen" class="form-control">
                    @foreach(tbl_PhanQuyen quyen in TempData.Peek("ListPhanQuyen") as List<tbl_PhanQuyen>)
            {
                <option value="@quyen.MaQuyen">@quyen.ChucVu</option>
            }
                </select>
            </div>
        </div>

        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-primary" onclick="ThemTaiKhoan()">
                <i class="fas fa-save"></i> Thêm tài khoản
            </button>
        </div>
    </form>
</div>

<script>
    function ThemTaiKhoan() {
        //Reset biến kiểm tra:
        hasFocus = false;

        let HoTen = $('[name=txt_HoTen]');
        let HoTen_val = HoTen.val();
        if (HoTen_val.length == 0) {
            TryFocus(HoTen);
            ShowFailMessage("Không được để trống họ và tên!");
        }
        else if (HoTen_val.length > 200) {
            TryFocus(HoTen);
            ShowFailMessage("Họ và tên không vượt quá 200 ký tự!");
        }
        else if (!ValidTen(HoTen_val)) {
            TryFocus(HoTen);
            ShowFailMessage("Họ và tên quá ngắn hoặc chứa ký tự đặc biệt!");
        }

        let NgaySinh = $('[name=txt_NgaySinh]');
        let NgaySinh_val = NgaySinh.val();
        if (NgaySinh_val == 0) {
            TryFocus(NgaySinh);
            ShowFailMessage("Ngày sinh trống hoặc giá trị không hợp lệ!");
        }
        else {
            let nsDate = new Date(NgaySinh_val);
            let date = new Date();
            if (date.getFullYear() - nsDate.getFullYear() < 15) {
                TryFocus(NgaySinh);
                ShowFailMessage("Ngày sinh không hợp lệ!");
            }
        }

        let SDT = $('[name=txt_SDT]');
        let SDT_val = SDT.val();
        if (SDT_val.length == 0) {
            TryFocus(SDT);
            ShowFailMessage("Không được để trống số điện thoại!");
        }
        else if (SDT_val.length > 11) {
            ShowFailMessage("Số điện thoại không vượt quá 11 ký tự!");
        }
        else if (!ValidSDT(SDT_val)) {
            TryFocus(SDT);
            ShowFailMessage("Số điện thoại chỉ chứa các ký tự 0-9!");
        }

        let TaiKhoan = $('[name=txt_TaiKhoan]');
        let TaiKhoan_val = TaiKhoan.val();
        if (TaiKhoan_val.length == 0) {
            TryFocus(TaiKhoan);
            ShowFailMessage("Không được để trống tài khoản!");
        }
        else if (TaiKhoan_val.length > 100) {
            TryFocus(TaiKhoan);
            ShowFailMessage("Tên tài khoản không vượt quá 100 ký tự!");
        }
        else if (!ValidTaiKhoan(TaiKhoan_val)) {
            TryFocus(TaiKhoan);
            ShowFailMessage("Tên tài khoản chỉ chứa các ký tự A-Z a-z 0-9 và _!");
        }

        let MatKhau = $('[name=txt_MatKhau]');
        let MatKhau_val = MatKhau.val();
        if (MatKhau_val.length == 0) {
            TryFocus(MatKhau);
            ShowFailMessage("Không được để mật khẩu!");
        }
        else if (MatKhau_val.length < 6) {
            TryFocus(MatKhau);
            ShowFailMessage("Mật khẩu phải chứa ít nhất 6 ký tự!");
        }
        else if (MatKhau_val.length > 100) {
            TryFocus(MatKhau);
            ShowFailMessage("Mật khẩu không vượt quá 100 ký tự!");
        }
        else if (!ValidTaiKhoan(MatKhau_val)) {
            TryFocus(MatKhau);
            ShowFailMessage("Mật khẩu chỉ chứa các ký tự A-Z a-z 9-0 và _!");
        }

        let ReMatKhau = $('[name=txt_ReMatKhau]');
        let ReMatKhau_val = ReMatKhau.val();
        if (ReMatKhau_val != MatKhau_val) {
            TryFocus(ReMatKhau);
            ShowFailMessage("Hai trường mật khẩu không khớp nhau!");
        }

        //Khi dữ liệu đã đúng:

        if (!hasFocus) {
            ShowUIContent("Xác nhận thêm tài khoản " + TaiKhoan_val + "?");
        }
    }

    $(function () {
        $('.UI-accept').click(function () {
            UIContentToLoading();

            let form = $('.form-themtk');
            let dataForm = form.serialize();
            let image = $('#avatar').prop("src");
            dataForm += "&Avatar=" + image;

            $.ajax({
                url: "@LocalLinks.PostThemTaiKhoan",
                method: "POST",
                data: dataForm,
                success: function (result, status, xhr) {
                    let rs = JSON.parse(result);
                    console.log(rs);

                    if (rs.ErrCode == 7) {
                        ShowFailMessage("Tên tài khoản đã tồn tại, vui lòng sử dụng tên tài khoản khác!");
                        TryFocus($('[name=txt_TaiKhoan]'));
                    }
                    else if (rs.ErrCode == 11) {
                        ShowFailMessage(rs.ErrDes);
                    }
                    else if (rs.ErrCode == 2) {
                        ShowUIBlock();
                        ShowSuccessMessage("Thêm tài khoản thành công, tự động chuyển hướng sau khi hết thông báo!", function () { window.location.href = "@LocalLinks.QuanLyTaiKhoan"; });
                    }
                },
                error: function (xhr, status, error) {
                    ShowFailMessage("Mất kết nối với máy chủ, vui lòng thử lại sau ít phút!");
                }
            }).always(function () {
                HideLoading();
            });
        });
    });

    function ReplaceImage(ele) {
        let image = ele.files[0];
        //$('#avatar').prop("src", URL.createObjectURL(image));
        ConvertFileToBase64(image, (e) => {
            $('#avatar').prop("src", e.target.result);
        });
    }
</script>
